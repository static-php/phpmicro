import{_ as i,c as a,o as h,af as n}from"./chunks/framework.BKqm66bb.js";const g=JSON.parse('{"title":"构建 micro SAPI","description":"","frontmatter":{},"headers":[],"relativePath":"zh/build-micro.md","filePath":"zh/build-micro.md"}'),p={name:"zh/build-micro.md"};function l(t,s,e,k,r,d){return h(),a("div",null,[...s[0]||(s[0]=[n(`<h1 id="构建-micro-sapi" tabindex="-1">构建 micro SAPI <a class="header-anchor" href="#构建-micro-sapi" aria-label="Permalink to “构建 micro SAPI”">​</a></h1><h2 id="使用-static-php-cli-推荐" tabindex="-1">使用 static-php-cli（推荐） <a class="header-anchor" href="#使用-static-php-cli-推荐" aria-label="Permalink to “使用 static-php-cli（推荐）”">​</a></h2><p>因为 micro SAPI 的特性，最好使用静态编译的方式来构建 PHP 运行时和相关扩展。 我们推荐使用 <a href="https://static-php.dev" target="_blank" rel="noreferrer">static-php-cli</a> 来构建包含 micro SAPI 的静态 PHP 二进制文件。</p><p>你可以按照 static-php.dev 文档中的步骤构建自己的包含 micro SAPI 的静态 PHP 二进制文件。大致步骤如下：</p><h3 id="安装-spc-工具" tabindex="-1">安装 SPC 工具 <a class="header-anchor" href="#安装-spc-工具" aria-label="Permalink to “安装 SPC 工具”">​</a></h3><p><strong>Linux/macOS:</strong></p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># For Linux x86_64</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -fsSL</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> spc</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://dl.static-php.dev/static-php-cli/spc-bin/nightly/spc-linux-x86_64</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># For Linux aarch64</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -fsSL</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> spc</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://dl.static-php.dev/static-php-cli/spc-bin/nightly/spc-linux-aarch64</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># macOS x86_64 (Intel)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -fsSL</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> spc</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://dl.static-php.dev/static-php-cli/spc-bin/nightly/spc-macos-x86_64</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># macOS aarch64 (Apple)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -fsSL</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> spc</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://dl.static-php.dev/static-php-cli/spc-bin/nightly/spc-macos-aarch64</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 添加执行权限</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">chmod</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> +x</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ./spc</span></span></code></pre></div><p><strong>Windows:</strong></p><div class="language-powershell"><button title="Copy Code" class="copy"></button><span class="lang">powershell</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">curl.exe</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">fsSL </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">o </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">spc.exe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> https:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">//</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">dl.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">static-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">php.dev</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/static-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">php</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cli</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">spc</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">bin</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">nightly</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">spc-windows-x64.exe</span></span></code></pre></div><h3 id="创建-craft-配置文件" tabindex="-1">创建 Craft 配置文件 <a class="header-anchor" href="#创建-craft-配置文件" aria-label="Permalink to “创建 Craft 配置文件”">​</a></h3><p>创建一个 <code>craft.yml</code> 文件，指定你想要包含的扩展列表。支持的扩展参见 <a href="https://static-php.dev/en/guide/extensions.html" target="_blank" rel="noreferrer">扩展列表</a> 或 <a href="https://static-php.dev/en/guide/cli-generator.html" target="_blank" rel="noreferrer">命令生成器</a>。</p><div class="language-yml"><button title="Copy Code" class="copy"></button><span class="lang">yml</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># PHP 版本支持: 8.1, 8.2, 8.3, 8.4, 8.5</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">php-version</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">8.4</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 在这里放入你的扩展列表</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">extensions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;bcmath,phar,openssl,mbstring&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">sapi</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">cli</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">micro</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">download-options</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  prefer-pre-built</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span></code></pre></div><h3 id="构建静态-php-二进制文件" tabindex="-1">构建静态 PHP 二进制文件 <a class="header-anchor" href="#构建静态-php-二进制文件" aria-label="Permalink to “构建静态 PHP 二进制文件”">​</a></h3><p>运行以下命令来构建包含 micro SAPI 的静态 PHP 二进制文件：</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./spc</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> craft</span></span></code></pre></div><p>构建完成后，你可以在 <code>buildroot/bin/</code> 目录下找到生成的 <code>micro.sfx</code> 文件。将其复制到你想要使用的地方，即可开始使用 micro SAPI 运行你的 PHP 应用程序。</p><p>最后，你可以使用 spc 的 <code>micro:combine</code> 命令将 <code>micro.sfx</code> 与你的 PHP 代码或 PHAR 文件连接起来，形成一个自执行的二进制文件：</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;&lt;?php echo &quot;Hello, Micro SAPI!\\n&quot;;&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> app.php</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./spc</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> micro:combine</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> app.php</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -O</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> myapp</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./myapp</span></span></code></pre></div><p>当然，在不包含任何其他配置的情况下，你也可以用 bash 和 powershell 手动完成这一过程：</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Linux/macOS</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cat</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> buildroot/bin/micro.sfx</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> app.php</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> myapp</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">chmod</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> +x</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ./myapp</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./myapp</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Windows</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">COPY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /b</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> buildroot</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\b</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">in</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\m</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">icro.sfx</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> +</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> app.php</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> myapp.exe</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">\\</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">myapp.exe</span></span></code></pre></div><p>更多构建选项和细节，请参考 <a href="https://static-php.dev/en/guide/manual-build" target="_blank" rel="noreferrer">static-php.dev 文档</a>。</p><h2 id="其他构建方法" tabindex="-1">其他构建方法 <a class="header-anchor" href="#其他构建方法" aria-label="Permalink to “其他构建方法”">​</a></h2><p>除了使用 static-php-cli，你也可以选择从 PHP 源代码手动编译 micro SAPI。请参考 PHP 官方文档中的<a href="https://www.php.net/manual/en/install.unix.source.php" target="_blank" rel="noreferrer">编译指南</a>了解更多细节。</p><p>手动编译 micro SAPI 一般只建议在调试 micro SAPI 本身时使用。通常情况下，推荐使用 static-php-cli 来构建静态链接的 micro SAPI 二进制文件。</p><p>下面为大致的手动编译一个包含最小扩展组合的 micro.sfx 步骤，具体细节可能会根据你的系统环境有所不同。</p><h3 id="准备-php-源码" tabindex="-1">准备 PHP 源码 <a class="header-anchor" href="#准备-php-源码" aria-label="Permalink to “准备 PHP 源码”">​</a></h3><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">git</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> clone</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://github.com/php/php-src.git</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> php-src</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">git</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> clone</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://github.com/static-php/phpmicro.git</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sapi/micro</span></span></code></pre></div><h3 id="配置和编译" tabindex="-1">配置和编译 <a class="header-anchor" href="#配置和编译" aria-label="Permalink to “配置和编译”">​</a></h3><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./buildconf</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --force</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./configure</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --enable-micro</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --disable-all</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --enable-cli</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --with-openssl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --with-zlib</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --enable-phar</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --enable-mbstring</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --enable-bcmath</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">make</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -j$(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">nproc</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 生成的 micro.sfx 位于 sapi/micro/micro.sfx</span></span></code></pre></div>`,29)])])}const F=i(p,[["render",l]]);export{g as __pageData,F as default};
