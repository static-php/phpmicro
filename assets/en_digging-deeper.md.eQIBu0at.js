import{_ as s,c as a,o as e,af as n,ag as t}from"./chunks/framework.BKqm66bb.js";const g=JSON.parse('{"title":"Digging Deeper into micro SAPI","description":"","frontmatter":{},"headers":[],"relativePath":"en/digging-deeper.md","filePath":"en/digging-deeper.md"}'),l={name:"en/digging-deeper.md"};function h(p,i,r,o,k,d){return e(),a("div",null,[...i[0]||(i[0]=[n(`<h1 id="digging-deeper-into-micro-sapi" tabindex="-1">Digging Deeper into micro SAPI <a class="header-anchor" href="#digging-deeper-into-micro-sapi" aria-label="Permalink to “Digging Deeper into micro SAPI”">​</a></h1><h2 id="how-micro-sapi-loads" tabindex="-1">How micro SAPI Loads <a class="header-anchor" href="#how-micro-sapi-loads" aria-label="Permalink to “How micro SAPI Loads”">​</a></h2><p>Simply put, micro.sfx itself contains a complete PHP interpreter. Without any INI injection or concatenated PHP code, it&#39;s no different from other ELF, PE, or Mach-O executable files on the system.</p><p>When we concatenate PHP code or a Phar file to the end of micro.sfx, the file structure looks like this:</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>&lt;-- File head for myapp</span></span>
<span class="line"><span>|--------------------------------|--------------------------------------|</span></span>
<span class="line"><span>| micro.sfx (ELF/PE/Mach-O part) |             PHP/Phar part            |</span></span>
<span class="line"><span>|            Binary              |             plaintext/phar           |</span></span>
<span class="line"><span>| 010101010101010101010101010101 | &lt;?php code(); .......                |</span></span>
<span class="line"><span>|--------------------------------|--------------------------------------|</span></span></code></pre></div><p>When we execute <code>./myapp</code>, the operating system loads the entire file into memory and begins executing the micro.sfx portion of the code. micro SAPI detects that there&#39;s PHP code or a Phar file at the end of the file and passes it as input to the built-in PHP interpreter for execution.</p><p><img src="`+t+`" alt=""></p><p>This design allows micro SAPI to run PHP code very efficiently because it avoids the traditional file extraction and temporary storage steps, executing code directly in memory.</p><h2 id="ini-injection-principles" tabindex="-1">INI Injection Principles <a class="header-anchor" href="#ini-injection-principles" aria-label="Permalink to “INI Injection Principles”">​</a></h2><p>micro SAPI supports dynamically modifying PHP configuration options at runtime through INI injection. The principle is that when micro.sfx starts, it reads INI configuration embedded in the binary file and applies it to the PHP interpreter&#39;s configuration environment.</p><p>The INI injection block structure is as follows:</p><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> MICRO_INI_HEADER{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    uint32_t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> magic;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // &quot;\\xfd\\xf6\\x69\\xe6&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    uint32_t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> size;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // in big-endian</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">__attribute__</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((packed));</span></span></code></pre></div><p>Append the INI injection block to the end of the micro.sfx file, then append PHP code or Phar file. The final file structure is as follows:</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>&lt;-- File head for myapp</span></span>
<span class="line"><span>|--------------------------------|---------------------------------------------------|-------------------------|</span></span>
<span class="line"><span>| micro.sfx (ELF/PE/Mach-O part) |              INI Injection Block                  |     PHP/Phar part       |</span></span>
<span class="line"><span>|            Binary              | 4 byte magic | INI data size |     INI data       |     plaintext/phar      |</span></span>
<span class="line"><span>| 010101010101010101010101010101 | 0xfdf669e6   | 0x0000002A    | &quot;memory_limit=...&quot; | &quot;&lt;?php code(); .......&quot; |</span></span>
<span class="line"><span>|--------------------------------|---------------------------------------------------|-------------------------|</span></span></code></pre></div><p>When micro.sfx starts, it checks whether a valid INI injection block exists at the end of the file (by checking the magic field). If it exists, micro SAPI reads the INI data, parses it into PHP configuration options, and applies them to the current PHP runtime environment.</p><p>You can use the <code>micro:combine</code> command provided by static-php-cli to automatically complete this process, or use the script below to manually build an INI injection block and append it to micro.sfx:</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./spc</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> micro:combine</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> app.php</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -I</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;memory_limit=512M&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -I</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;display_errors=1&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -O</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> myapp</span></span></code></pre></div><div class="language-php"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Prepare INI block</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$ini_data </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;memory_limit=512M</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">display_errors=1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$ini_block </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> fopen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ini_block.bin&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;wb&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">fwrite</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($ini_block, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">pack</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;N&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0xfdf669e6</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// magic</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">fwrite</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($ini_block, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">pack</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;N&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">strlen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($ini_data))); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// size</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">fwrite</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($ini_block, $ini_data);</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">fclose</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($ini_block);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Append INI block and PHP code to micro.sfx</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$micro </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> fopen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;micro.sfx&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ab&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$ini_block </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> fopen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ini_block.bin&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;rb&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">feof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($ini_block)) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    fwrite</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($micro, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">fread</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($ini_block, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">8192</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">fclose</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($ini_block);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$php_code </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> fopen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;app.php&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;rb&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">feof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($php_code)) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    fwrite</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($micro, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">fread</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($php_code, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">8192</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">fclose</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($php_code);</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">fclose</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($micro);</span></span></code></pre></div><h2 id="micro-defined-methods" tabindex="-1">micro-defined Methods <a class="header-anchor" href="#micro-defined-methods" aria-label="Permalink to “micro-defined Methods”">​</a></h2><p>micro SAPI defines some PHP functions and constants for interacting with PHP code.</p><h3 id="sapi-functions" tabindex="-1">SAPI Functions <a class="header-anchor" href="#sapi-functions" aria-label="Permalink to “SAPI Functions”">​</a></h3><ul><li><code>php_sapi_name()</code>: Returns the current SAPI name. For micro SAPI, it returns &quot;micro&quot; by default. If SAPI name masquerading is enabled, it returns &quot;cli&quot;.</li><li><code>micro_version()</code>: Returns micro SAPI version information.</li><li><code>micro_get_self_filename()</code>: Returns the absolute path of the current self-executing file. It&#39;s similar to the <code>__FILE__</code> constant but applicable to micro SAPI.</li><li><code>micro_get_sfxsize()</code>: Returns the size (in bytes) of the micro.sfx executable portion, excluding the appended PHP code and INI injection block.</li></ul><h2 id="reading-phar-files" tabindex="-1">Reading Phar Files <a class="header-anchor" href="#reading-phar-files" aria-label="Permalink to “Reading Phar Files”">​</a></h2><p>PHP&#39;s Phar archives are similar to compression formats like zip and rar, but they&#39;re specifically designed for PHP applications. Phar files can contain multiple PHP scripts, resource files, and metadata, making PHP application distribution and deployment much more convenient.</p><p>In a normal PHP environment, files within a Phar can be loaded and executed via <code>require</code>, such as <code>require &#39;phar://path/to/archive.phar/file.php&#39;;</code>.</p><p>However, for micro.sfx, it&#39;s slightly more complex. For micro applications, the phar file itself is appended to the end of the micro.sfx executable, not a separate file. Generally, after concatenating micro.sfx and a phar file, using other SAPIs to read this phar file is not feasible because other SAPIs cannot recognize the micro.sfx file structure.</p><p>To allow micro to correctly read its own phar file, we must modify the phar extension source code to enable it to recognize the micro.sfx file structure, allowing the phar archive to be read starting from the end of micro.sfx.</p><p>In static-php-cli, we have already made corresponding modifications to the phar extension to make it compatible with micro SAPI. Therefore, when using files within a phar in micro, point the phar archive to the micro.sfx file itself, for example:</p><div class="language-php"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$file_content </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> file_get_contents</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;phar://&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> micro_get_self_filename</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;/path/inside/phar.php&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><h2 id="loading-dynamic-extensions" tabindex="-1">Loading Dynamic Extensions <a class="header-anchor" href="#loading-dynamic-extensions" aria-label="Permalink to “Loading Dynamic Extensions”">​</a></h2><p>For Linux systems, micro SAPI only supports loading external shared libraries and external PHP extensions (.so files) when using dynamically linked glibc static binaries. static-php-cli builds pure static binaries based on statically linked musl-libc by default, which don&#39;t support loading external extensions. You need to build a glibc-compatible binary according to the documentation to achieve this feature.</p><p>For more information about building with glibc on Linux, please refer to the <a href="https://static-php.dev/en/guide/build-with-glibc" target="_blank" rel="noreferrer">Building glibc-compatible Linux Binaries</a> section in the static-php-cli documentation.</p><p>For macOS systems, micro SAPI supports loading external dynamic libraries and PHP extensions by default. You need to specify the <code>extension</code> option through INI injection or other means to load external extensions.</p><p>For Windows systems, due to the different linking mechanisms on the Windows platform, loading dynamic extensions through micro SAPI is currently not supported, but you can statically compile the FFI extension and use FFI functionality to call other DLLs that are not extensions.</p>`,34)])])}const E=s(l,[["render",h]]);export{g as __pageData,E as default};
